<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø´Ø±Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
      }

      .exam-card.active {
        border-color: #9333ea;
        background-color: #faf5ff;
        box-shadow: 0 4px 6px -1px rgba(147, 51, 234, 0.2);
      }
      .exam-card.active .check-indicator {
        opacity: 1;
        transform: scale(1);
      }
      .fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø´Ø·ÙˆØ¨ */
      .line-through-price {
        text-decoration: line-through;
        color: #9ca3af;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body class="bg-[#f8f9fa] text-gray-700 pb-40">
    <div class="max-w-7xl mx-auto p-6 space-y-8">
      <div class="flex justify-between items-end">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">ØªØ®ØµÙŠØµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
          <p class="text-sm text-gray-500 mt-1">
            Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ Ø«Ù… Ø§Ø¨Ø­Ø« ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨
          </p>
        </div>
        <div class="text-left">
          <!-- <span class="block text-xs text-gray-400">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</span>
          <span class="text-xl font-bold text-purple-600">5,000 Ø±.Ø³</span> -->
        </div>
      </div>

      <section>
        <h2
          class="text-sm font-bold text-gray-400 uppercase mb-4 tracking-wider"
        >
          1. Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
        </h2>
        <div
          id="cards-container"
          class="grid grid-cols-1 md:grid-cols-3 gap-6"
        ></div>
      </section>

      <section id="studentsSection" class="hidden fade-in space-y-4">
        <div
          class="flex flex-col md:flex-row md:justify-between md:items-center gap-4"
        >
          <h2
            class="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"
          >
            2. Ø­Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù€:
            <span
              id="selectedExamTitle"
              class="text-purple-700 bg-purple-100 px-3 py-1 rounded-lg text-xs font-bold shadow-sm"
            ></span>
          </h2>

          <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="relative w-full md:w-64">
              <div
                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
              >
                <svg
                  class="w-4 h-4 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  ></path>
                </svg>
              </div>
              <input
                type="text"
                id="searchInput"
                oninput="handleSearch(this.value)"
                class="block w-full p-2 pr-10 text-sm text-gray-900 border border-gray-200 rounded-lg bg-white focus:ring-purple-500 focus:border-purple-500"
                placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..."
              />
            </div>

            <button
              onclick="toggleSelectAll()"
              class="text-xs bg-white border border-gray-200 px-4 py-2.5 rounded-lg hover:bg-gray-50 text-gray-600 font-medium whitespace-nowrap"
            >
              ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            </button>
          </div>
        </div>

        <div
          class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <table class="w-full text-sm text-right text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr>
                <th scope="col" class="p-4 w-4"></th>
                <th scope="col" class="px-6 py-4">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th scope="col" class="px-6 py-4">Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹</th>
                <th scope="col" class="px-6 py-4">Ø§Ù„Ø¹Ø¯Ø¯</th>
                <th scope="col" class="px-6 py-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody"></tbody>
          </table>

          <div id="emptyState" class="hidden p-12 text-center">
            <div class="text-4xl mb-2">ğŸ”</div>
            <p class="text-gray-500 font-medium">
              Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø¨Ø­Ø«Ùƒ Ø£Ùˆ Ø¬Ù…ÙŠØ¹Ù‡Ù… ÙŠÙ…Ù„ÙƒÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.
            </p>
          </div>
        </div>
      </section>
    </div>

    <div
      id="checkoutBar"
      class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] p-4 transform translate-y-full transition-transform duration-300 z-50"
    >
      <div
        class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <div class="flex items-center gap-4 w-full md:w-auto">
          <div
            class="bg-purple-100 p-2 rounded-lg text-purple-600 hidden md:block"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
          </div>
          <div>
            <p class="text-xs text-gray-400">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</p>
            <p class="font-bold text-gray-800 text-lg">
              <span id="selectedCount">0</span> Ø·Ø§Ù„Ø¨
            </p>
          </div>
        </div>

        <div
          class="flex flex-col md:flex-row items-center gap-4 md:gap-8 w-full md:w-auto"
        >
          <div class="flex items-center gap-2 w-full md:w-auto">
            <div class="relative w-full">
              <input
                type="text"
                id="couponCode"
                placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (KSA2030)"
                class="w-full md:w-40 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2.5 uppercase"
              />
              <div
                id="couponSuccess"
                class="hidden absolute left-2 top-2.5 text-green-500"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
            </div>
            <button
              onclick="applyCoupon()"
              id="btnApplyCoupon"
              class="text-white bg-gray-800 hover:bg-gray-900 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-2.5"
            >
              ØªØ·Ø¨ÙŠÙ‚
            </button>
          </div>

          <div
            class="text-left w-full md:w-auto flex justify-between md:block px-2 md:px-0"
          >
            <p class="text-xs text-gray-400">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
            <div class="flex items-baseline gap-2">
              <span id="originalPrice" class="hidden line-through-price"></span>
              <p class="font-bold text-gray-800 text-2xl">
                <span id="totalCost">0</span>
                <span class="text-sm font-normal text-gray-500">Ø±.Ø³</span>
              </p>
            </div>
          </div>

          <button
            id="confirmBtn"
            onclick="confirmPurchase()"
            class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-purple-200 transition-all flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
          >
            <span id="btnText">ØªØ£ÙƒÙŠØ¯ ÙˆØ´Ø±Ø§Ø¡</span>
            <div id="btnIcon">
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14 5l7 7m0 0l-7 7m7-7H3"
                ></path>
              </svg>
            </div>
            <div id="loadingIcon" class="hidden">
              <svg
                class="animate-spin h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </div>
          </button>
        </div>
      </div>
    </div>
    <div id="redirectModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-sm border border-gray-100">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <div class="mx-auto flex h-16 w-16 flex-shrink-0 items-center justify-center rounded-full bg-green-50 mb-4 animate-bounce">
                                <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                                </svg>
                            </div>
                            
                            <h3 class="text-xl font-bold leading-6 text-gray-900 text-center" id="modal-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 text-center">
                                    Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø£Ù…Ø§Ù†.
                                </p>
                            </div>

                            <div class="mt-6 flex justify-center">
                                <div class="flex space-x-2 space-x-reverse">
                                    <div class="w-2 h-2 bg-purple-600 rounded-full animate-pulse"></div>
                                    <div class="w-2 h-2 bg-purple-600 rounded-full animate-pulse delay-75"></div>
                                    <div class="w-2 h-2 bg-purple-600 rounded-full animate-pulse delay-150"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
      // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
      const info = {
        p1: {
          icon: "ğŸ¯",
          label: "Holland",
          title: "Ù…Ù‚ÙŠØ§Ø³ Ù‡ÙˆÙ„Ø§Ù†Ø¯ Ù„Ù„Ù…ÙŠÙˆÙ„ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©",
        },
        p2: {
          icon: "ğŸ§ ",
          label: "MBTI",
          title: "Ù…Ù‚ÙŠØ§Ø³ Ù…Ø§ÙŠØ±Ø²-Ø¨Ø±ÙŠØ¬Ø² Ù„Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø®ØµÙŠØ©",
        },
        p3: {
          icon: "ğŸ’¡",
          label: "Gardner",
          title: "Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø°ÙƒØ§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¬Ø§Ø±Ø¯Ù†Ø±",
        },
      };

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Mock Data)
      const studentsData = JSON.parse('<%-data %>');
      let currentExam = null;
      let selectedStudentIds = new Set();
      let searchTerm = ""; // Ù…ØªØºÙŠØ± Ø§Ù„Ø¨Ø­Ø«
      let discountMultiplier = 1; // 1 ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø³Ø¹Ø± ÙƒØ§Ù…Ù„ØŒ 0.8 ÙŠØ¹Ù†ÙŠ Ø®ØµÙ… 20%
      const EXAM_PRICE = 50;

      // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---
      function initPage() {
        const container = document.getElementById("cards-container");
        Object.keys(info).forEach((key) => {
          const item = info[key];
          const availableCount = studentsData.filter(
            (s) => !s.exams.includes(key)
          ).length;
          container.innerHTML += `
                <div onclick="selectExamType('${key}')" id="card-${key}" class="exam-card cursor-pointer bg-white rounded-xl p-6 border-2 border-transparent hover:border-gray-200 transition-all relative group shadow-sm flex flex-col h-full">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-2xl bg-gray-50 text-2xl flex items-center justify-center shadow-inner">${item.icon}</div>
                        <div class="check-indicator opacity-0 transform scale-50 transition-all duration-200 text-purple-600 bg-purple-50 rounded-full p-1">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1 leading-snug">${item.title}</h3>
                    <div class="mt-auto pt-4 flex justify-between items-center border-t border-gray-50">
                        <span class="text-xs font-semibold text-gray-400 tracking-wider">${item.label}</span>
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-md">Ù…ØªØ§Ø­: ${availableCount}</span>
                    </div>
                </div>`;
        });
      }

      // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
      function selectExamType(examKey) {
        currentExam = examKey;
        selectedStudentIds.clear();
        searchTerm = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        document.getElementById("searchInput").value = "";

        updateCheckoutBar();

        document
          .querySelectorAll(".exam-card")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`card-${examKey}`).classList.add("active");
        document.getElementById("selectedExamTitle").innerText =
          info[examKey].title;
        document.getElementById("studentsSection").classList.remove("hidden");

        renderTable();
      }

      function handleSearch(val) {
        searchTerm = val.toLowerCase();
        renderTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
      }

      function getFilteredStudents() {
        // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ†:
        // 1. Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        // 2. ÙˆØ§Ø³Ù…Ù‡Ù… ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«
        return studentsData.filter(
          (student) =>
            !student.exams.includes(currentExam) &&
            student.name.toLowerCase().includes(searchTerm)
        );
      }

      function renderTable() {
        const tbody = document.getElementById("studentsTableBody");
        tbody.innerHTML = "";

        const studentsToShow = getFilteredStudents();

        if (studentsToShow.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          document.querySelector("table").classList.add("hidden");
        } else {
          document.getElementById("emptyState").classList.add("hidden");
          document.querySelector("table").classList.remove("hidden");
        }

        studentsToShow.forEach((student) => {
          const tr = document.createElement("tr");
          tr.className =
            "bg-white border-b hover:bg-gray-50 cursor-pointer transition-colors group";
          tr.onclick = (e) => {
            if (e.target.type !== "checkbox") toggleStudent(student._id);
          };

          const isSelected = selectedStudentIds.has(student._id);
          const existingBadges = student.exams
            .map((examCode) => {
              const label = info[examCode] ? info[examCode].label : examCode;
              return `<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded border border-gray-200 font-mono">${label}</span>`;
            })
            .join(" ");

          // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ---
          // Ù†ØªØ­Ù‚Ù‚: Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø«ØŸ Ø¥Ø°Ø§ Ù†Ø¹Ù… Ù†Ù„ÙˆÙ†ØŒ Ø¥Ø°Ø§ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ Ù‡Ùˆ
          const displayName = searchTerm
            ? student.name.replace(
                new RegExp(searchTerm, "gi"),
                (match) => `<span class="bg-yellow-200">${match}</span>`
              )
            : student.name;

          tr.innerHTML = `
            <td class="p-4 w-4">
                <input type="checkbox" onchange="toggleStudent('${
                  student._id
                }')" ${
            isSelected ? "checked" : ""
          } class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 cursor-pointer">
            </td>
            <td class="px-6 py-4 font-medium text-gray-900">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-sm border border-indigo-100">${student.name.charAt(
                      0
                    )}</div>
                    ${displayName}
                </div>
            </td>
            <td class="px-6 py-4"><div class="flex gap-1 flex-wrap">${
              existingBadges ||
              '<span class="text-xs text-gray-300">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>'
            }</div></td>
            <td class="px-6 py-4 text-gray-400 text-xs">${
              student.totalExams
            }</td>
            <td class="px-6 py-4"><span class="bg-green-50 text-green-700 text-xs px-2 py-1 rounded border border-green-100">Ù…ØªØ§Ø­</span></td>
        `;
          tbody.appendChild(tr);
        });
      }
      function toggleStudent(id) {
        if (selectedStudentIds.has(id)) selectedStudentIds.delete(id);
        else selectedStudentIds.add(id);

        const checkbox = document.querySelector(
          `input[onchange="toggleStudent('${id}')"]`
        );
        if (checkbox) checkbox.checked = selectedStudentIds.has(id);
        updateCheckoutBar();
      }

      function toggleSelectAll() {
        // Ù†Ø­Ø¯Ø¯ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø§Ù„Ù…ÙÙ„ØªØ±ÙŠÙ† Ø¨Ø§Ù„Ø¨Ø­Ø«)
        const visibleStudents = getFilteredStudents();
        const allVisibleSelected = visibleStudents.every((s) =>
          selectedStudentIds.has(s._id)
        );

        if (allVisibleSelected) {
          // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ† ÙÙ‚Ø·
          visibleStudents.forEach((s) => selectedStudentIds.delete(s._id));
        } else {
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ†
          visibleStudents.forEach((s) => selectedStudentIds.add(s._id));
        }
        renderTable();
        updateCheckoutBar();
      }

      // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ ---
      function applyCoupon() {
        const input = document.getElementById("couponCode");
        const btn = document.getElementById("btnApplyCoupon");
        const code = input.value.trim().toUpperCase();

        // ØªØ­Ù‚Ù‚ ÙˆÙ‡Ù…ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API)
        if (code === "KSA2030") {
          discountMultiplier = 0.8; // Ø®ØµÙ… 20%

          // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
          input.disabled = true;
          input.classList.add(
            "bg-green-50",
            "text-green-700",
            "border-green-200"
          );
          document.getElementById("couponSuccess").classList.remove("hidden");
          btn.innerText = "ØªÙ… Ø§Ù„Ø®ØµÙ…";
          btn.classList.replace("bg-gray-800", "bg-green-600");
          btn.disabled = true;

          updateCheckoutBar(); // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
        } else {
          // Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
          input.classList.add(
            "border-red-500",
            "focus:border-red-500",
            "focus:ring-red-500"
          );
          setTimeout(
            () =>
              input.classList.remove(
                "border-red-500",
                "focus:border-red-500",
                "focus:ring-red-500"
              ),
            2000
          );
          alert("Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ­ÙŠØ­");
        }
      }

      function updateCheckoutBar() {
        const bar = document.getElementById("checkoutBar");
        const count = selectedStudentIds.size;
        const originalTotal = count * EXAM_PRICE;
        const finalTotal = originalTotal * discountMultiplier;

        document.getElementById("selectedCount").innerText = count;

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
        const totalCostEl = document.getElementById("totalCost");
        const originalPriceEl = document.getElementById("originalPrice");

        totalCostEl.innerText = finalTotal.toLocaleString();

        if (discountMultiplier < 1 && count > 0) {
          originalPriceEl.innerText = originalTotal.toLocaleString();
          originalPriceEl.classList.remove("hidden");
          totalCostEl.classList.add("text-green-600");
        } else {
          originalPriceEl.classList.add("hidden");
          totalCostEl.classList.remove("text-green-600");
        }

        if (count > 0) bar.classList.remove("translate-y-full");
        else bar.classList.add("translate-y-full");
      }

      function confirmPurchase() {
    const btn = document.getElementById('confirmBtn');
    const btnText = document.getElementById('btnText');
    const btnIcon = document.getElementById('btnIcon');
    const loadingIcon = document.getElementById('loadingIcon');
    const modal = document.getElementById('redirectModal');
    // 1. ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø²Ø±
    btn.disabled = true;
    btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
    btnIcon.classList.add('hidden');
    loadingIcon.classList.remove('hidden');
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ (API Call)
    modal.classList.remove('hidden');
    btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ Ù„Ù„Ø¯ÙØ¹...";
        const dataToSend = {
          exam: currentExam,
          studentIds: Array.from(selectedStudentIds),
          coupon: document.getElementById("couponCode").value,
          finalPrice: document.getElementById("totalCost").innerText,
        };
        console.log(dataToSend);
        fetch("", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataToSend),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status == "success" && data.url.startsWith("http")) {
              // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
              window.location.href = data.url;
            } else {
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
              resetPaymentButton(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
              modal.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            }
          });
      }

      // Ø¯Ø§Ù„Ø© Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
// function confirmPurchase() {
//     const btn = document.getElementById('confirmBtn');
//     const btnText = document.getElementById('btnText');
//     const btnIcon = document.getElementById('btnIcon');
//     const loadingIcon = document.getElementById('loadingIcon');
//     const modal = document.getElementById('redirectModal');
//     // 1. ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø²Ø±
//     btn.disabled = true;
//     btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
//     btnIcon.classList.add('hidden');
//     loadingIcon.classList.remove('hidden');
//     // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ (API Call)
//     modal.classList.remove('hidden');
//     btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ Ù„Ù„Ø¯ÙØ¹...";
//     // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
//     // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
    
//     setTimeout(() => {
//         // Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Redirect)
//         setTimeout(() => {
//             // ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§ ØªØ¶Ø¹: window.location.href = '/payment';
            
//             // Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø· Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø±
//             resetPaymentButton(); 
            
//         }, 3000); // Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†ÙŠ Ø«Ù… ÙŠØ®ØªÙÙŠ

//     }, 1000); // Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ØªØ­Ù‚Ù‚
// }

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
function resetPaymentButton() {
    const btn = document.getElementById('confirmBtn');
    const btnText = document.getElementById('btnText');
    const btnIcon = document.getElementById('btnIcon');
    const loadingIcon = document.getElementById('loadingIcon');
    const modal = document.getElementById('redirectModal');

    if(btn) {
        btn.disabled = false;
        btnText.innerText = "ØªØ£ÙƒÙŠØ¯ ÙˆØ´Ø±Ø§Ø¡";
        btnIcon.classList.remove('hidden');
        loadingIcon.classList.add('hidden');
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø£ÙŠØ¶Ø§Ù‹
        if(modal) modal.classList.add('hidden');
    }
}
      initPage();
    </script>
  </body>
</html>
