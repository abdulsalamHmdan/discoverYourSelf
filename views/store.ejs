<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>اشتراكات مقياس بصيرة</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
        --selected-bg: #e8f6fd;
        --border-color: #ddd;
        --success-color: #27ae60;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 20px;
        padding-bottom: 100px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      /* تنسيق الكروت (نفس السابق) */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .product-card {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        text-align: center;
      }

      .product-card.active {
        border-color: var(--accent-color);
        background-color: var(--selected-bg);
      }

      .product-card.active::after {
        content: "✔";
        position: absolute;
        top: -10px;
        right: -10px;
        background: var(--accent-color);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* حالة تم الشراء */
      .product-card.purchased {
        border-color: var(--success-color);
        background-color: #f0fdf4;
        cursor: default;
        pointer-events: none;
      }
      .product-card.purchased .product-price {
        color: var(--success-color);
        font-size: 1.1rem;
      }
      .product-card.purchased::after {
        content: "مملوك";
        position: absolute;
        top: -10px;
        right: -10px;
        background: var(--success-color);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
      }

      .product-title {
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--primary-color);
      }
      .product-desc {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 15px;
      }
      .product-price {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      /* الشريط السفلي */
      .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px 20px;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 900;
        max-width: 800px;
        margin: 0 auto;
        border-radius: 15px 15px 0 0;
      }

      .pay-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Tajawal", sans-serif;
        cursor: pointer;
      }
      .pay-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* ---------------- نافذة تفاصيل الطلب (Modal) ---------------- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.show {
        display: flex;
        opacity: 1;
      }

      .modal-content {
        background: white;
        width: 90%;
        max-width: 450px;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        transform: translateY(20px);
        transition: transform 0.3s;
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .close-modal {
        cursor: pointer;
        font-size: 1.5rem;
        color: #999;
      }

      /* قائمة الطلبات */
      .order-summary-list {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
      }
      .order-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }
      .order-item.total-row {
        font-weight: bold;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
        font-size: 1.1rem;
      }
      .discount-row {
        color: var(--success-color);
        font-size: 0.9rem;
      }

      /* خانة الكوبون */
      .coupon-section {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .coupon-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family: "Tajawal";
        outline: none;
      }
      .coupon-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 0 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Tajawal";
      }

      .confirm-btn {
        width: 100%;
        background: var(--primary-color);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* حركة التحميل */
      .spinner {
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s infinite linear;
        margin-left: 10px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="text-align: center; color: var(--primary-color)">
        مقياس بصيرة
      </h1>

      <div class="products-grid">
        <div
          class="product-card <%= exams.includes('p1') ? 'purchased' : '' %>"
          onclick="toggleProduct(this, 99, 'p1')"
        >
          <div class="product-title">أنماط الشخصية</div>
          <div class="product-desc">تحليل شامل لنمط شخصيتك.</div>
          <div class="product-price">
            <%= exams.includes('p1') ? 'تم الشراء' : '99 ر.س' %>
          </div>
          <!-- <div class="product-price">99 ر.س</div> -->
        </div>

        <div
          class="product-card <%= exams.includes('p2') ? 'purchased' : '' %>"
          onclick="toggleProduct(this, 120, 'p2')"
        >
          <div class="product-title">الميول المهني</div>
          <div class="product-desc">اكتشف المسارات الوظيفية.</div>
          <div class="product-price">
            <%= exams.includes('p2') ? 'تم الشراء' : '120 ر.س' %>
          </div>
        </div>

        <div
          class="product-card <%= exams.includes('p3') ? 'purchased' : '' %>"
          onclick="toggleProduct(this, 199, 'p3')"
        >
          <div class="product-title">الذكاء العاطفي</div>
          <div class="product-desc">قياس مهارات التواصل والمشاعر.</div>
          <div class="product-price">
            <%= exams.includes('p3') ? 'تم الشراء' : '199 ر.س' %>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <div>
        <span style="color: #777">المجموع:</span>
        <strong id="mainTotalDisplay" style="font-size: 1.2rem">0</strong> ر.س
      </div>
      <button
        class="pay-btn"
        id="mainPayBtn"
        onclick="openCheckoutModal()"
        disabled
      >
        متابعة الشراء
      </button>
    </div>

    <div class="modal-overlay" id="checkoutModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ملخص الطلب</h3>
          <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>

        <ul class="order-summary-list" id="orderSummary"></ul>

        <div class="coupon-section">
          <input
            type="text"
            id="couponCode"
            class="coupon-input"
            placeholder="لديك كود خصم؟"
          />
          <button class="coupon-btn" onclick="applyCoupon()">تطبيق</button>
        </div>
        <div
          id="couponMessage"
          style="margin-top: -15px; margin-bottom: 15px; font-size: 0.8rem"
        ></div>

        <button class="confirm-btn" id="confirmBtn" onclick="processPayment()">
          تأكيد والدفع
        </button>
      </div>
    </div>

    <script>
      // البيانات
      let cart = []; // لتخزين العناصر المختارة {name, price}
      let totalAmount = 0;
      let discountAmount = 0;

      // 1. دالة اختيار المنتجات
      function toggleProduct(card, price, name) {
        if (card.classList.contains("active")) {
          // إزالة
          card.classList.remove("active");
          cart = cart.filter((item) => item.name !== name);
          totalAmount -= price;
        } else {
          // إضافة
          card.classList.add("active");
          cart.push({ name: name, price: price });
          totalAmount += price;
        }
        updateMainUI();
      }

      // تحديث واجهة الشريط السفلي
      function updateMainUI() {
        document.getElementById("mainTotalDisplay").innerText = totalAmount;
        const btn = document.getElementById("mainPayBtn");
        if (totalAmount > 0) {
          btn.disabled = false;
          btn.innerText = `متابعة (${cart.length})`;
        } else {
          btn.disabled = true;
          btn.innerText = "متابعة الشراء";
        }
      }

      // 2. فتح نافذة الدفع (Modal)
      function openCheckoutModal() {
        const modal = document.getElementById("checkoutModal");
        const list = document.getElementById("orderSummary");

        // إعادة تعيين الخصم عند فتح النافذة من جديد
        discountAmount = 0;
        document.getElementById("couponCode").value = "";
        document.getElementById("couponMessage").innerText = "";

        // بناء القائمة
        list.innerHTML = "";
        cart.forEach((item) => {
          list.innerHTML += `
                    <li class="order-item">
                        <span>${item.name}</span>
                        <span>${item.price} ر.س</span>
                    </li>
                `;
        });

        // إضافة سطر المجموع النهائي
        renderTotalRow();

        // إظهار النافذة
        modal.classList.add("show");
      }

      function closeModal() {
        document.getElementById("checkoutModal").classList.remove("show");
      }

      // رسم سطر المجموع داخل المودال
      function renderTotalRow() {
        const list = document.getElementById("orderSummary");
        // حذف سطور المجموع القديمة إن وجدت لإعادة رسمها
        const oldTotals = list.querySelectorAll(".total-calc");
        oldTotals.forEach((el) => el.remove());

        let finalTotal = totalAmount - discountAmount;
        if (finalTotal < 0) finalTotal = 0;

        let html = "";

        // عرض الخصم إن وجد
        if (discountAmount > 0) {
          html += `
                <li class="order-item discount-row total-calc">
                    <span>قيمة الخصم</span>
                    <span>-${discountAmount} ر.س</span>
                </li>`;
        }

        // المجموع النهائي
        html += `
            <li class="order-item total-row total-calc">
                <span>الإجمالي النهائي</span>
                <span style="color: var(--primary-color);">${finalTotal} ر.س</span>
            </li>`;

        list.insertAdjacentHTML("beforeend", html);
      }

      // 3. تفعيل الكوبون
      function applyCoupon() {
        const code = document.getElementById("couponCode").value.toUpperCase();
        const msg = document.getElementById("couponMessage");

        // مثال بسيط للكوبون (BASIRA10)
        if (code === "BASIRA10") {
          discountAmount = 10; // خصم 10 ريال
          msg.style.color = "green";
          msg.innerText = "تم تطبيق الخصم بنجاح!";
          renderTotalRow(); // تحديث الأرقام
        } else {
          discountAmount = 0;
          msg.style.color = "red";
          msg.innerText = "كود الخصم غير صحيح";
          renderTotalRow();
        }
      }

      // 4. معالجة الدفع النهائية
      function processPayment() {
        const btn = document.getElementById("confirmBtn");
        const finalPrice = Math.max(0, totalAmount - discountAmount);

        btn.innerHTML = '<div class="spinner"></div> جاري المعالجة...';
        btn.disabled = true;
        btn.style.opacity = "0.8";

        console.log("--- طلب جديد ---");
        console.log("المنتجات:", cart);
        console.log("الكوبون:", document.getElementById("couponCode").value);
        console.log("المبلغ النهائي:", finalPrice);
        var data = new URLSearchParams();
        data.append("price", finalPrice);
        data.append("exams", JSON.stringify(cart.map((item) => item.name)));
        fetch("/payment", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body: data,
        })
          .then((response) => {
            return response.text();
          })
          .then((x) => {
            // إعادة التوجيه لصفحة الدفع
            if (x.startsWith("http")) {
              location.href = x;
            } else {
              alert("حدث خطأ أثناء إنشاء طلب الدفع. الرجاء المحاولة مرة أخرى.");
              closeModal();
            }
          })
          .catch(() => {
            console.log("error");
          });
      }

      // إغلاق النافذة عند الضغط في الخارج
      window.onclick = function (event) {
        const modal = document.getElementById("checkoutModal");
        if (event.target == modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
