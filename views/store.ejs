<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù‚ÙŠØ§Ø³ Ø¨ØµÙŠØ±Ø©</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
        --selected-bg: #e8f6fd;
        --border-color: #ddd;
        --success-color: #27ae60;
      }

      body {
        font-family: "Tajawal", sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 20px;
        padding-bottom: 100px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ±ÙˆØª */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 30px;
      }

      .product-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .product-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
      }

      /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        min-height: 100px;
      }

      .product-card:nth-child(2) .card-header {
        background: linear-gradient(135deg, #c86dd7 0%, #7b68ee 100%);
      }

      .product-card:nth-child(3) .card-header {
        background: linear-gradient(135deg, #6366f1 0%, #a78bfa 100%);
      }

      .product-icon {
        font-size: 2.5rem;
      }

      .card-badge {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        backdrop-filter: blur(10px);
        position: absolute;
        top: 10px;
        right: 10px;
      }

      /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
      .card-content {
        padding: 24px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .product-title {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 12px;
        color: var(--primary-color);
        line-height: 1.4;
        max-width: 100%;
      }
      .product-desc {
        font-size: 0.9rem;
        color: #5a6c7d;
        margin-bottom: 16px;
        line-height: 1.6;
        flex-grow: 1;
      }

      /* Ø­Ø§Ù„Ø© ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ */
      .product-card.purchased .card-header {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      }

      .product-card.purchased {
        cursor: default;
      }
/* 
      .product-card.purchased .card-header::after {
        content: "Ù…Ù…Ù„ÙˆÙƒ";
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
      } */

      /* Ø­Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø© (Active) */
      .product-card.active .card-header {
        box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5);
      }

      .product-card.active .card-header::after {
        content: "âœ”";
        position: absolute;
        top: 6px;
        left: 6px;
        background: #27ae60;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      /* Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ */
      .store-link {
        display: none;
      }

      /* Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© */
      .select-btn {
        padding: 12px 28px;
        font-size: 0.95rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 12px;
      }

      .product-card:nth-child(2) .select-btn {
        background: linear-gradient(135deg, #c86dd7 0%, #7b68ee 100%);
      }

      .product-card:nth-child(3) .select-btn {
        background: linear-gradient(135deg, #6366f1 0%, #a78bfa 100%);
      }

      .select-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
      }

      .product-card.active .select-btn {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      }

      .product-card.purchased .select-btn {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        opacity: 0.7;
        cursor: default;
      }

      .product-price {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--accent-color);
        margin-top: 8px;
        text-align: center;
      }

      /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
      .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px 20px;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 900;
        max-width: 800px;
        margin: 0 auto;
        border-radius: 15px 15px 0 0;
      }

      .pay-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Tajawal", sans-serif;
        cursor: pointer;
      }
      .pay-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      /* ---------------- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Modal) ---------------- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.show {
        display: flex;
        opacity: 1;
      }

      .modal-content {
        background: white;
        width: 90%;
        max-width: 450px;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        position: relative;
        transform: translateY(20px);
        transition: transform 0.3s;
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .close-modal {
        cursor: pointer;
        font-size: 1.5rem;
        color: #999;
      }

      /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
      .order-summary-list {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
      }
      .order-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }
      .order-item.total-row {
        font-weight: bold;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
        font-size: 1.1rem;
      }
      .discount-row {
        color: var(--success-color);
        font-size: 0.9rem;
      }

      /* Ø®Ø§Ù†Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† */
      .coupon-section {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .coupon-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family: "Tajawal";
        outline: none;
      }
      .coupon-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 0 15px;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Tajawal";
      }

      .confirm-btn {
        width: 100%;
        background: var(--primary-color);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Ø­Ø±ÙƒØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
      .spinner {
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s infinite linear;
        margin-left: 10px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .products-grid {
          grid-template-columns: 1fr;
        }

        .container {
          max-width: 100%;
        }

        .product-card {
          aspect-ratio: auto;
        }
      }

      /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
      .back-btn {
        display: inline-block;
        /* margin-bottom: 0; */
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: "Tajawal", sans-serif;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background-color: #1a2332;
        transform: translateX(5px);
      }
    </style>
  </head>
  <body>
    <!-- <%- include('nav') %> -->
    <div class="container">
      <button class="back-btn" onclick="history.back();">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
      <h1 style="text-align: center; color: var(--primary-color)">
        Ù…Ù‚ÙŠØ§Ø³ Ø¨ØµÙŠØ±Ø©
      </h1>

      <div class="products-grid">
        <div class="product-card <%= exams.includes('p1') ? 'purchased' : '' %>" onclick="toggleProduct(this, 99, 'p1')">
          <div class="card-header">
            <span class="product-icon">ğŸ§©</span>
            <div class="card-badge">Gardner</div>
          </div>
          <div class="card-content">
            <h3 class="product-title">Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø°ÙƒØ§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø¬Ø§Ø±Ø¯Ù†Ø±</h3>
            <p class="product-desc">ÙŠØ³ØªÙ†Ø¯ Ø¥Ù„Ù‰ Ù†Ø¸Ø±ÙŠØ© Ù‡ÙˆØ§Ø±Ø¯ Ø¬Ø§Ø±Ø¯Ù†Ø± Ù„Ù„Ø°ÙƒØ§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ ÙˆÙŠÙ‚ÙŠØ³ Ø«Ù…Ø§Ù†ÙŠØ© Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡: Ø§Ù„Ù„ØºÙˆÙŠØŒ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ-Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØŒ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØŒ Ø§Ù„ØµÙˆØªÙŠØŒ Ø§Ù„Ø¬Ø³Ø¯ÙŠ-Ø§Ù„Ø­Ø±ÙƒÙŠØŒ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØŒ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØŒ ÙˆØ§Ù„Ø°Ø§ØªÙŠ. ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ù†Ù‚Ø§Ø· Ù‚ÙˆØªÙƒ Ø§Ù„ÙÙƒØ±ÙŠØ© Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø©.</p>
            <% if(!exams.includes('p1')) { %>
              <button class="select-btn" onclick="event.stopPropagation(); toggleProduct(this.parentElement.parentElement, 99, 'p1');">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
              <div class="product-price">99 Ø±.Ø³</div>
            <% } else { %>
              <div class="product-price">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ âœ“</div>
            <% } %>
          </div>
        </div>

        <div class="product-card <%= exams.includes('p2') ? 'purchased' : '' %>" onclick="toggleProduct(this, 120, 'p2')">
          <div class="card-header">
            <span class="product-icon">ğŸ§ </span>
            <div class="card-badge">MBTI</div>
          </div>
          <div class="card-content">
            <h3 class="product-title">Ù…Ù‚ÙŠØ§Ø³ Ù…Ø§ÙŠØ±Ø²-Ø¨Ø±ÙŠØ¬Ø² Ù„Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <p class="product-desc">Ø£Ø­Ø¯ Ø£Ø´Ù‡Ø± Ù…Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ØŒ ÙŠØ­Ø¯Ø¯ Ù†Ù…Ø·Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† Ø¨ÙŠÙ† 16 Ù†Ù…Ø·Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø±Ø¨Ø¹Ø© Ø£Ø¨Ø¹Ø§Ø¯: Ø§Ù„Ø§Ù†Ø·ÙˆØ§Ø¦ÙŠØ©/Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠØ©ØŒ Ø§Ù„Ø­Ø¯Ø³/Ø§Ù„Ø­Ø³ØŒ Ø§Ù„ØªÙÙƒÙŠØ±/Ø§Ù„Ø´Ø¹ÙˆØ±ØŒ ÙˆØ§Ù„Ø­ÙƒÙ…/Ø§Ù„Ø¥Ø¯Ø±Ø§Ùƒ. ÙŠÙˆÙØ± ÙÙ‡Ù…Ø§Ù‹ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ Ù„Ø·Ø±ÙŠÙ‚Ø© ØªÙÙƒÙŠØ±Ùƒ.</p>
            <% if(!exams.includes('p2')) { %>
              <button class="select-btn" onclick="event.stopPropagation(); toggleProduct(this.parentElement.parentElement, 120, 'p2');">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
              <div class="product-price">120 Ø±.Ø³</div>
            <% } else { %>
              <div class="product-price">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ âœ“</div>
            <% } %>
          </div>
        </div>

        <div class="product-card <%= exams.includes('p3') ? 'purchased' : '' %>" onclick="toggleProduct(this, 199, 'p3')">
          <div class="card-header">
            <span class="product-icon">ğŸ¯</span>
            <div class="card-badge">Holland</div>
          </div>
          <div class="card-content">
            <h3 class="product-title">Ù…Ù‚ÙŠØ§Ø³ Ù‡ÙˆÙ„Ø§Ù†Ø¯ Ù„Ù„Ù…ÙŠÙˆÙ„ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</h3>
            <p class="product-desc">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†Ø¸Ø±ÙŠØ© Ø¬ÙˆÙ† Ù‡ÙˆÙ„Ø§Ù†Ø¯ Ø§Ù„Ø´Ù‡ÙŠØ±Ø© Ø§Ù„ØªÙŠ ØªØµÙ†Ù Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø¥Ù„Ù‰ Ø³ØªØ© Ø£Ù†Ù…Ø§Ø· Ù…Ù‡Ù†ÙŠØ©: Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØŒ Ø§Ù„Ø§Ø³ØªÙ‚ØµØ§Ø¦ÙŠØŒ Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØŒ Ø§Ù„Ù…ØºØ§Ù…Ø±ØŒ ÙˆØ§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ. ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…ÙŠÙˆÙ„ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.</p>
            <% if(!exams.includes('p3')) { %>
              <button class="select-btn" onclick="event.stopPropagation(); toggleProduct(this.parentElement.parentElement, 199, 'p3');">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
              <div class="product-price">199 Ø±.Ø³</div>
            <% } else { %>
              <div class="product-price">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ âœ“</div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <div>
        <span style="color: #777">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
        <strong id="mainTotalDisplay" style="font-size: 1.2rem">0</strong> Ø±.Ø³
      </div>
      <button
        class="pay-btn"
        id="mainPayBtn"
        onclick="openCheckoutModal()"
        disabled
      >
        Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
      </button>
    </div>

    <div class="modal-overlay" id="checkoutModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
          <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>

        <ul class="order-summary-list" id="orderSummary"></ul>

        <div class="coupon-section">
          <input
            type="text"
            id="couponCode"
            class="coupon-input"
            placeholder="Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ Ø®ØµÙ…ØŸ"
          />
          <button class="coupon-btn" onclick="applyCoupon()">ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
        <div
          id="couponMessage"
          style="margin-top: -15px; margin-bottom: 15px; font-size: 0.8rem"
        ></div>

        <button class="confirm-btn" id="confirmBtn" onclick="processPayment()">
          ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ø¯ÙØ¹
        </button>
      </div>
    </div>

    <script>
      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      let cart = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© {name, price}
      let totalAmount = 0;
      let discountAmount = 0;

      // 1. Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      function toggleProduct(card, price, name) {
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©
        if (card.classList.contains("purchased")) {
          return;
        }
        if (card.classList.contains("active")) {
          // Ø¥Ø²Ø§Ù„Ø©
          card.classList.remove("active");
          cart = cart.filter((item) => item.name !== name);
          totalAmount -= price;
        } else {
          // Ø¥Ø¶Ø§ÙØ©
          card.classList.add("active");
          cart.push({ name: name, price: price });
          totalAmount += price;
        }
        updateMainUI();
      }

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
      function updateMainUI() {
        document.getElementById("mainTotalDisplay").innerText = totalAmount;
        const btn = document.getElementById("mainPayBtn");
        if (totalAmount > 0) {
          btn.disabled = false;
          btn.innerText = `Ù…ØªØ§Ø¨Ø¹Ø© (${cart.length})`;
        } else {
          btn.disabled = true;
          btn.innerText = "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø±Ø§Ø¡";
        }
      }
      // 2. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ (Modal)
      function openCheckoutModal() {
        const modal = document.getElementById("checkoutModal");
        const list = document.getElementById("orderSummary");

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯
        discountAmount = 0;
        document.getElementById("couponCode").value = "";
        document.getElementById("couponMessage").innerText = "";

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        list.innerHTML = "";
        cart.forEach((item) => {
          list.innerHTML += `
                    <li class="order-item">
                        <span>${item.name}</span>
                        <span>${item.price} Ø±.Ø³</span>
                    </li>
                `;
        });

        // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        renderTotalRow();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        modal.classList.add("show");
      }

      function closeModal() {
        document.getElementById("checkoutModal").classList.remove("show");
      }

      // Ø±Ø³Ù… Ø³Ø·Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      function renderTotalRow() {
        const list = document.getElementById("orderSummary");
        // Ø­Ø°Ù Ø³Ø·ÙˆØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…Ù‡Ø§
        const oldTotals = list.querySelectorAll(".total-calc");
        oldTotals.forEach((el) => el.remove());

        let finalTotal = totalAmount - discountAmount;
        if (finalTotal < 0) finalTotal = 0;

        let html = "";

        // Ø¹Ø±Ø¶ Ø§Ù„Ø®ØµÙ… Ø¥Ù† ÙˆØ¬Ø¯
        if (discountAmount > 0) {
          html += `
                <li class="order-item discount-row total-calc">
                    <span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</span>
                    <span>-${discountAmount} Ø±.Ø³</span>
                </li>`;
        }

        // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        html += `
            <li class="order-item total-row total-calc">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
                <span style="color: var(--primary-color);">${finalTotal} Ø±.Ø³</span>
            </li>`;

        list.insertAdjacentHTML("beforeend", html);
      }

      // 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†
      function applyCoupon() {
        const code = document.getElementById("couponCode").value.toUpperCase();
        const msg = document.getElementById("couponMessage");

        // Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ· Ù„Ù„ÙƒÙˆØ¨ÙˆÙ† (BASIRA10)
        if (code === "BASIRA10") {
          discountAmount = 10; // Ø®ØµÙ… 10 Ø±ÙŠØ§Ù„
          msg.style.color = "green";
          msg.innerText = "ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­!";
          renderTotalRow(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        } else {
          discountAmount = 0;
          msg.style.color = "red";
          msg.innerText = "ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ­ÙŠØ­";
          renderTotalRow();
        }
      }

      // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      function processPayment() {
        const btn = document.getElementById("confirmBtn");
        const finalPrice = Math.max(0, totalAmount - discountAmount);

        btn.innerHTML = '<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        btn.disabled = true;
        btn.style.opacity = "0.8";

        console.log("--- Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ---");
        console.log("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", cart);
        console.log("Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:", document.getElementById("couponCode").value);
        console.log("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:", finalPrice);
        var data = new URLSearchParams();
        data.append("price", finalPrice);
        data.append("exams", JSON.stringify(cart.map((item) => item.name)));
        fetch("/payment", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body: data,
        })
          .then((response) => {
            return response.json();
          })
          .then((x) => {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
            if (x.status === "success" && x.url) {
              location.href = x.url;
            } else {
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
              closeModal();
            }
          })
          .catch(() => {
            console.log("error");
          });
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬
      window.onclick = function (event) {
        const modal = document.getElementById("checkoutModal");
        if (event.target == modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
